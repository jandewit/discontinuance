---
title: "Untitled"
author: "Jan de Wit"
date: "2/23/2022"
output: word_document
---

```{r setup, include=TRUE}
rm(list = ls()) #Clear workspace
knitr::opts_chunk$set(echo = TRUE)

# Disable output of warnings to the generated doc file
# Set to FALSE for final doc, TRUE for debugging
knitr::opts_chunk$set(warning = TRUE)

##### Load packages

# For importing SPSS files
library(foreign)

# For filtering
library(dplyr)

# For %>% pipe
library(magrittr)

# For calculating number of days between two dates
library(lubridate)


##### Load dataset of all waves (not included on Github) and remove missing values

##### Wave 1
data_wave1_in <- read.spss('L_CoronaMelder_wave1_3p.sav', to.data.frame=TRUE, use.missings=FALSE)
# Filter out the respondents that did not complete the entire survey 
data_wave1 <- data_wave1_in[!is.na(data_wave1_in$duur),]
data_wave1['wave'] <- 1

## Calculate mean scores on the different factors
# UTAUT: Performance expectancy
data_wave1$PE1_UTAUTn <- as.numeric(data_wave1$PE1_UTAUT)
data_wave1$PE2_UTAUTn <- as.numeric(data_wave1$PE2_UTAUT)
data_wave1$PE_UTAUT <- rowMeans(data_wave1[, c("PE1_UTAUTn", "PE2_UTAUTn")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("PE1_UTAUTn", "PE2_UTAUTn")])
hist(data_wave1$PE_UTAUT)


# UTAUT: Effort expectancy (users)
data_wave1$EE1a_UTAUTn <- as.numeric(data_wave1$EE1a_UTAUT)
data_wave1$EE2a_UTAUTn <- as.numeric(data_wave1$EE2a_UTAUT)
# Since the item EE1a_UTAUT is negatively phrased, it will be reverse coded such that higher numbers refer to higher EE
data_wave1$EE1a_UTAUTn_r = car::recode(data_wave1$EE1a_UTAUTn, '1=7; 2=6; 3=5; 4=4; 5=3; 6=2; 7=1')
data_wave1$EEa_UTAUT <- rowMeans(data_wave1[, c("EE1a_UTAUTn_r", "EE2a_UTAUTn")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("EE1a_UTAUTn_r", "EE2a_UTAUTn")])
hist(data_wave1$EEa_UTAUT)


# UTAUT: Effort expectancy (non-users)
data_wave1$EE1b_UTAUTn <- as.numeric(data_wave1$EE1b_UTAUT)
data_wave1$EE2b_UTAUTn <- as.numeric(data_wave1$EE2b_UTAUT)
# Since the item EE1b_UTAUT is negatively phrased, it will be reverse coded such that higher numbers refer to higher EE
data_wave1$EE1b_UTAUTn_r = car::recode(data_wave1$EE1b_UTAUTn, '1=7; 2=6; 3=5; 4=4; 5=3; 6=2; 7=1')
data_wave1$EEb_UTAUT <- rowMeans(data_wave1[, c("EE1b_UTAUTn_r", "EE2b_UTAUTn")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("EE1b_UTAUTn_r", "EE2b_UTAUTn")])
hist(data_wave1$EEb_UTAUT)


# UTAUT: Effort expectancy (total)
data_wave1$EE1_UTAUT <- rowMeans(data_wave1[, c("EE1a_UTAUTn_r","EE1b_UTAUTn_r")], na.rm = TRUE)
data_wave1$EE2_UTAUT <- rowMeans(data_wave1[, c("EE2a_UTAUTn","EE2b_UTAUTn")], na.rm = TRUE)
data_wave1$EE_UTAUT <- rowMeans(data_wave1[, c("EE1_UTAUT", "EE2_UTAUT")], na.rm = TRUE)
psy::cronbach(data_wave1[, c("EE1_UTAUT","EE2_UTAUT")])
hist(data_wave1$EE_UTAUT)


# UTAUT: Social influence
data_wave1$SI1_UTAUTn <- as.numeric(data_wave1$SI1_UTAUT)
data_wave1$SI2_UTAUTn <- as.numeric(data_wave1$SI2_UTAUT)
data_wave1$SI_UTAUT <- rowMeans(data_wave1[, c("SI1_UTAUTn", "SI2_UTAUTn")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("SI1_UTAUTn", "SI2_UTAUTn")])
hist(data_wave1$SI_UTAUT)


# UTAUT: Facilitating conditions
data_wave1$FC1_UTAUTn <- as.numeric(data_wave1$FC1_UTAUT)
data_wave1$FC2_UTAUTn <- as.numeric(data_wave1$FC2_UTAUT)
data_wave1$FC_UTAUT <- rowMeans(data_wave1[, c("FC1_UTAUTn", "FC2_UTAUTn")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("FC1_UTAUTn", "FC2_UTAUTn")])
hist(data_wave1$FC_UTAUT)


# HBM: Perceived susceptibility
data_wave1$HBM_PSus_self1n <- as.numeric(data_wave1$HBM_PSus_self1)
data_wave1$HBM_PSus_self2n <- as.numeric(data_wave1$HBM_PSus_self2)
data_wave1$HBM_PSus_self <- rowMeans(data_wave1[, c("HBM_PSus_self1n", "HBM_PSus_self2n")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("HBM_PSus_self1n", "HBM_PSus_self2n")])
hist(data_wave1$HBM_PSus_self)


# HBM: Perceived severity
data_wave1$HBM_PSev_self1n <- as.numeric(data_wave1$HBM_PSev_self1)
data_wave1$HBM_PSev_self2n <- as.numeric(data_wave1$HBM_PSev_self2)
data_wave1$HBM_PSev_self <- rowMeans(data_wave1[, c("HBM_PSev_self1n", "HBM_PSev_self2n")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("HBM_PSev_self1n", "HBM_PSev_self2n")])
hist(data_wave1$HBM_PSev_self)


# The variables measured from not true - true (5 point scales with 'I don't know as answer options) are recoded, so that 'I don't know' represents the middle value. This should also be recoded, as more data safety is fewer concerns.
data_wave1$Beliefs_datasafetyn <- as.numeric(data_wave1$Beliefs_datasafety)
data_wave1$Beliefs_datasafety_5p <- car::recode(data_wave1$Beliefs_datasafetyn, '1=5; 2=4; 3=2; 4=1; 5=3') 

bla <- data.frame(levels = unique(data_wave1$Beliefs_datasafety), value = as.numeric(unique(data_wave1$Beliefs_datasafety)))

# From Nadine
data_wave1$Beliefs_technologyperformancen <- as.numeric(data_wave1$Beliefs_technologyperformance)
data_wave1$Beliefs_falsesecurity1n <- as.numeric(data_wave1$Beliefs_falsesecurity1)
data_wave1$Beliefs_falsesecurity2n <- as.numeric(data_wave1$Beliefs_falsesecurity2)
data_wave1$Beliefs_technologyperformance_5p <- car::recode(data_wave1$Beliefs_technologyperformancen, '1=1; 2=2; 3=4; 4=5; 5=3') 
data_wave1$Beliefs_falsesecurity1_5p <- car::recode(data_wave1$Beliefs_falsesecurity1n, '1=1; 2=2; 3=4; 4=5; 5=3') 
data_wave1$Beliefs_falsesecurity2_5p <- car::recode(data_wave1$Beliefs_falsesecurity2n, '1=1; 2=2; 3=4; 4=5; 5=3') 

data_wave1 <- data_wave1 %>% mutate(Infectother = case_when( 
  data_wave1$CoronaInfectionOther_1 == 1 | data_wave1$CoronaInfectionOther_2 == 1 | data_wave1$CoronaInfectionOther_3 == 1 | data_wave1$CoronaInfectionOther_4 == 1 | data_wave1$CoronaInfectionOther_5 == 1 | data_wave1$CoronaInfectionOther_6 == 1 ~ 1,
  data_wave1$CoronaInfectionOther_7 == 1 | data_wave1$CoronaInfectionOther_8 == 1 ~ 0))

infectotherprop <- table(data_wave1$Infectother) / length (data_wave1$Infectother)



# Contextual: False security beliefs
#data_wave1$Beliefs_falsesecurity1n <- as.numeric(data_wave1$Beliefs_falsesecurity1)
#data_wave1$Beliefs_falsesecurity2n <- as.numeric(data_wave1$Beliefs_falsesecurity2)
#data_wave1$Beliefs_falsesecurity <- rowMeans(data_wave1[, c("Beliefs_falsesecurity1n", "Beliefs_falsesecurity2n")], na.rm = TRUE)

#psy::cronbach(data_wave1[, c("Beliefs_falsesecurity1n", "Beliefs_falsesecurity2n")])
#hist(data_wave1$Beliefs_falsesecurity)

# Contextual: Societal beliefs
data_wave1$Beliefs_civicdutyn <- as.numeric(data_wave1$Beliefs_civicduty)
data_wave1$Beliefs_benefiteconomicn <- as.numeric(data_wave1$Beliefs_benefiteconomic)
data_wave1$Beliefs_Protectriskgroupsn <- as.numeric(data_wave1$Beliefs_Protectriskgroups)
data_wave1$Beliefs_TrustGovernmentn <- as.numeric(data_wave1$Beliefs_TrustGovernment)
data_wave1$Beliefs_Society <- rowMeans(data_wave1[, c("Beliefs_civicdutyn", "Beliefs_benefiteconomicn", "Beliefs_Protectriskgroupsn", "Beliefs_TrustGovernmentn")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("Beliefs_civicdutyn", "Beliefs_benefiteconomicn", "Beliefs_Protectriskgroupsn", "Beliefs_TrustGovernmentn")])
hist(data_wave1$Beliefs_Society)


# Contextual: Conspiracy beliefs
data_wave1$Beliefs_Conspiracy1n <- as.numeric(data_wave1$Beliefs_Conspiracy1)
data_wave1$Beliefs_Conspiracy2n <- as.numeric(data_wave1$Beliefs_Conspiracy2)

# The variables measured from not true - true (5 point scales with 'I don't know as answer options) are recoded, so that 'I don't know' represents the middle value.
data_wave1$Beliefs_Conspiracy1_5p <- car::recode(data_wave1$Beliefs_Conspiracy1n, '1=1; 2=2; 3=4; 4=5; 5=3') 
data_wave1$Beliefs_Conspiracy2_5p <- car::recode(data_wave1$Beliefs_Conspiracy2n, '1=1; 2=2; 3=4; 4=5; 5=3') 


data_wave1$Beliefs_Conspiracy <- rowMeans(data_wave1[, c("Beliefs_Conspiracy1_5p", "Beliefs_Conspiracy2_5p")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("Beliefs_Conspiracy1_5p", "Beliefs_Conspiracy2_5p")])
hist(data_wave1$Beliefs_Conspiracy)


# Contextual: Monitoring beliefs
data_wave1$Beliefs_locationmonitoringn <- as.numeric(data_wave1$Beliefs_locationmonitoring)
data_wave1$Beliefs_identitymonitoringn <- as.numeric(data_wave1$Beliefs_identitymonitoring)

# The variables measured from not true - true (5 point scales with 'I don't know as answer options) are recoded, so that 'I don't know' represents the middle value.
data_wave1$Beliefs_locationmonitoring_5p <- car::recode(data_wave1$Beliefs_locationmonitoringn, '1=1; 2=2; 3=4; 4=5; 5=3') 
data_wave1$Beliefs_identitymonitoring_5p <- car::recode(data_wave1$Beliefs_identitymonitoringn, '1=1; 2=2; 3=4; 4=5; 5=3')

data_wave1$Beliefs_monitoring <- rowMeans(data_wave1[, c("Beliefs_locationmonitoring_5p", "Beliefs_identitymonitoring_5p")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("Beliefs_locationmonitoring_5p", "Beliefs_identitymonitoring_5p")])
#psy::cronbach(data_wave1[, c("Beliefs_locationmonitoring_5p", "Beliefs_identitymonitoring_5p", "Beliefs_datasafety_5p")])
hist(data_wave1$Beliefs_monitoring)


# Contextual: Fear beliefs
data_wave1$Beliefs_fearn <- as.numeric(data_wave1$Beliefs_fear)
data_wave1$Beliefs_notificationfearn <- as.numeric(data_wave1$Beliefs_notificationfear)
data_wave1$Beliefs_fearB <- rowMeans(data_wave1[, c("Beliefs_fearn", "Beliefs_notificationfearn")], na.rm = TRUE)

psy::cronbach(data_wave1[, c("Beliefs_fearn", "Beliefs_notificationfearn")])
hist(data_wave1$Beliefs_fearB)


##### Wave 2
data_wave2_in <- read.spss('L_Corona_app_wave2_3p.sav', to.data.frame=TRUE, use.missings=FALSE)
# Filter out the respondents that did not complete the entire survey 
data_wave2 <- data_wave2_in[!is.na(data_wave2_in$duur),]
data_wave2['wave'] <- 2

##### Wave 3
data_wave3_in <- read.spss('L_Corona_app_wave3_3p.sav', to.data.frame=TRUE, use.missings=FALSE)
# Filter out the respondents that did not complete the entire survey 
data_wave3 <- data_wave3_in[!is.na(data_wave3_in$duur),]
data_wave3['wave'] <- 3

##### Wave 4
data_wave4_in <- read.spss('L_Corona_app_wave4_3p.sav', to.data.frame=TRUE, use.missings=FALSE)
# Filter out the respondents that did not complete the entire survey 
data_wave4 <- data_wave4_in[!is.na(data_wave4_in$duur),]
data_wave4['wave'] <- 4

##### Wave 5
data_wave5_in <- read.spss('L_Corona_app_wave5_3p.sav', to.data.frame=TRUE, use.missings=FALSE)
# Filter out the respondents that did not complete the entire survey 
data_wave5 <- data_wave5_in[!is.na(data_wave5_in$duur),]
data_wave5['wave'] <- 5

##### Wave 6
data_wave6_in <- read.spss('L_Corona_app_wave6_3p.sav', to.data.frame=TRUE, use.missings=FALSE)
# Filter out the respondents that did not complete the entire survey 
data_wave6 <- data_wave6_in[!is.na(data_wave6_in$duur),]
data_wave6['wave'] <- 6

# Remove columns that are not present in all waves
data_wave1 <- data_wave1[, intersect(colnames(data_wave1), colnames(data_wave2))]
data_wave1 <- data_wave1[, intersect(colnames(data_wave1), colnames(data_wave3))]
data_wave1 <- data_wave1[, intersect(colnames(data_wave1), colnames(data_wave4))]
data_wave1 <- data_wave1[, intersect(colnames(data_wave1), colnames(data_wave5))]
data_wave1 <- data_wave1[, intersect(colnames(data_wave1), colnames(data_wave6))]

data_wave2 <- data_wave2[, intersect(colnames(data_wave2), colnames(data_wave1))]
data_wave3 <- data_wave3[, intersect(colnames(data_wave3), colnames(data_wave1))]
data_wave4 <- data_wave4[, intersect(colnames(data_wave4), colnames(data_wave1))]
data_wave5 <- data_wave5[, intersect(colnames(data_wave5), colnames(data_wave1))]
data_wave6 <- data_wave6[, intersect(colnames(data_wave6), colnames(data_wave1))]

# Remove respondents from wave 5 and 6 that did not participate in waves 2-4
data_wave5 = data_wave5[(data_wave5$nomem_encr %in% data_wave4$nomem_encr),]
data_wave6 = data_wave6[(data_wave6$nomem_encr %in% data_wave5$nomem_encr),]


# Some tests to identify respondents who said they never used the CoronaMelder even though in other waves they did report using it
test2 <- filter(data_wave2, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave1[data_wave1$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr))

test3 <- filter(data_wave3, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave2[data_wave2$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr))

test4 <- filter(data_wave4, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave3[data_wave3$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr))

test5 <- filter(data_wave5, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave4[data_wave4$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr))

test6 <- filter(data_wave6, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave5[data_wave5$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr))


# Make a long table with all rows with respondents, their start time (start using), and event time (stop using), if applicable, otherwise right censored

# In wave 1, people who have used but already stopped have stopped within the first few weeks that the app was available. We therefore set start time to 0 and event to 1 (month)
# Use months instead of waves because they are not equally spaced
# use %in% to find those that were not using last wave
data_wave1['event'] <- 0
data_wave1['month'] <- 1

data_wave1[data_wave1$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]['event'] <- 1
data_wave1[data_wave1$Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt",]['event'] <- 1

data_complete <- data_wave1[data_wave1$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]
data_complete <- rbind(data_complete, data_wave1[data_wave1$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",])


# === WAVE 2 ===
data_wave2['event'] <- 0
data_wave2['month'] <- 1

data_wave2[data_wave2$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]['event'] <- 1
data_wave2[data_wave2$Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt",]['event'] <- 1

# People that stopped
data_new_wave2 <- filter(data_wave2, Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer" & !(nomem_encr %in% data_wave1[data_wave1$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]$nomem_encr))

# More people that stopped (but indicated that they never used it)
data_new_wave2 <- rbind(data_new_wave2, filter(data_wave2, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave1[data_wave1$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

# Ongoing users
data_new_wave2 <- rbind(data_new_wave2, filter(data_wave2, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & (nomem_encr %in% data_wave1[data_wave1$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

for (row in 1:nrow(data_new_wave2)) {
  # Like with wave 1, also in later waves it is possible that someone started using and stopped again, even within one wave
  # This checks for that situation, and puts month to 1 if it is the case
  if (is.na(min(data_complete[data_complete$nomem_encr == data_new_wave2[row, "nomem_encr"],]$DatumE))) {
    data_new_wave2[row, "month"] <- 1
  } else {
    first_wave <- min(data_complete[data_complete$nomem_encr == data_new_wave2[row, "nomem_encr"],]$wave)
    date_current <- as.Date(data_new_wave2[row, "DatumE"], "%d-%m-%Y")
    date_start <- as.Date(filter(data_complete, wave == first_wave & nomem_encr == data_new_wave2[row, "nomem_encr"])$DatumE, "%d-%m-%Y")
    
    days <- interval(date_start, date_current) %/% days(1)
    data_new_wave2[row, "month"] <- round(days / 30) + 1
    
  }
}

# Newly started
data_new_wave2 <- rbind(data_new_wave2, filter(data_wave2, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & !(nomem_encr %in% data_wave1[data_wave1$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

#b <- filter(data_new_wave2, nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)

data_complete <- rbind(data_complete, filter(data_new_wave2, !(nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)))


# === WAVE 3 ===
data_wave3['event'] <- 0
data_wave3['month'] <- 1

data_wave3[data_wave3$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]['event'] <- 1
data_wave3[data_wave3$Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt",]['event'] <- 1

# People that stopped
data_new_wave3 <- filter(data_wave3, Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer" & !(nomem_encr %in% data_wave2[data_wave2$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]$nomem_encr))

# More people that stopped (but indicated that they never used it)
data_new_wave3 <- rbind(data_new_wave3, filter(data_wave3, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave2[data_wave2$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

# Ongoing users
data_new_wave3 <- rbind(data_new_wave3, filter(data_wave3, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & (nomem_encr %in% data_wave2[data_wave2$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

for (row in 1:nrow(data_new_wave3)) {
  # Like with wave 1, also in later waves it is possible that someone started using and stopped again, even within one wave
  # This checks for that situation, and puts month to 1 if it is the case
  if (is.na(min(data_complete[data_complete$nomem_encr == data_new_wave3[row, "nomem_encr"],]$DatumE))) {
    data_new_wave3[row, "month"] <- 1
  } else {
    
    first_wave <- min(data_complete[data_complete$nomem_encr == data_new_wave3[row, "nomem_encr"],]$wave)
    date_current <- as.Date(data_new_wave3[row, "DatumE"], "%d-%m-%Y")
    date_start <- as.Date(filter(data_complete, wave == first_wave & nomem_encr == data_new_wave3[row, "nomem_encr"])$DatumE, "%d-%m-%Y")
    
    days <- interval(date_start, date_current) %/% days(1)
    data_new_wave3[row, "month"] <- round(days / 30) + 1
  }
}

# Newly started
data_new_wave3 <- rbind(data_new_wave3, filter(data_wave3, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & !(nomem_encr %in% data_wave2[data_wave2$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

#b <- filter(data_new_wave3, nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)

data_complete <- rbind(data_complete, filter(data_new_wave3, !(nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)))



# === WAVE 4 ===
data_wave4['event'] <- 0
data_wave4['month'] <- 1

data_wave4[data_wave4$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]['event'] <- 1
data_wave4[data_wave4$Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt",]['event'] <- 1

# People that stopped
data_new_wave4 <- filter(data_wave4, Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer" & !(nomem_encr %in% data_wave3[data_wave3$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]$nomem_encr))

# More people that stopped (but indicated that they never used it)
data_new_wave4 <- rbind(data_new_wave4, filter(data_wave4, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave3[data_wave3$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

# Ongoing users
data_new_wave4 <- rbind(data_new_wave4, filter(data_wave4, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & (nomem_encr %in% data_wave3[data_wave3$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

for (row in 1:nrow(data_new_wave4)) {
  # Like with wave 1, also in later waves it is possible that someone started using and stopped again, even within one wave
  # This checks for that situation, and puts month to 1 if it is the case
  if (is.na(min(data_complete[data_complete$nomem_encr == data_new_wave4[row, "nomem_encr"],]$DatumE))) {
    data_new_wave4[row, "month"] <- 1
  } else {
    
    first_wave <- min(data_complete[data_complete$nomem_encr == data_new_wave4[row, "nomem_encr"],]$wave)
    date_current <- as.Date(data_new_wave4[row, "DatumE"], "%d-%m-%Y")
    date_start <- as.Date(filter(data_complete, wave == first_wave & nomem_encr == data_new_wave4[row, "nomem_encr"])$DatumE, "%d-%m-%Y")
    
    days <- interval(date_start, date_current) %/% days(1)
    data_new_wave4[row, "month"] <- round(days / 30) + 1
  }
}

# Newly started
data_new_wave4 <- rbind(data_new_wave4, filter(data_wave4, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & !(nomem_encr %in% data_wave3[data_wave3$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

#b <- filter(data_new_wave4, nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)

data_complete <- rbind(data_complete, filter(data_new_wave4, !(nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)))




# === WAVE 5 ===
data_wave5['event'] <- 0
data_wave5['month'] <- 1

data_wave5[data_wave5$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]['event'] <- 1
data_wave5[data_wave5$Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt",]['event'] <- 1

# People that stopped
data_new_wave5 <- filter(data_wave5, Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer" & !(nomem_encr %in% data_wave4[data_wave4$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]$nomem_encr))

# More people that stopped (but indicated that they never used it)
data_new_wave5 <- rbind(data_new_wave5, filter(data_wave5, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave4[data_wave4$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

# Ongoing users
data_new_wave5 <- rbind(data_new_wave5, filter(data_wave5, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & (nomem_encr %in% data_wave4[data_wave4$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

for (row in 1:nrow(data_new_wave5)) {
  # Like with wave 1, also in later waves it is possible that someone started using and stopped again, even within one wave
  # This checks for that situation, and puts month to 1 if it is the case
  if (is.na(min(data_complete[data_complete$nomem_encr == data_new_wave5[row, "nomem_encr"],]$DatumE))) {
    data_new_wave5[row, "month"] <- 1
  } else {
    
    first_wave <- min(data_complete[data_complete$nomem_encr == data_new_wave5[row, "nomem_encr"],]$wave)
    
    # For some reason the date format in waves 5 and 6 are different
    date_current <- as.Date(data_new_wave5[row, "DatumE"], "%Y-%m-%d")
    
    # Now we need to check the date format, because the starting wave could be 1-4 (old format) or 5-6 (new format)
    if(unlist(gregexpr('-', filter(data_complete, wave == first_wave & nomem_encr == data_new_wave5[row, "nomem_encr"])$DatumE))[1] == 3) {
      date_start <- as.Date(filter(data_complete, wave == first_wave & nomem_encr == data_new_wave5[row, "nomem_encr"])$DatumE, "%d-%m-%Y")
      
    } else {
      date_start <- as.Date(filter(data_complete, wave == first_wave & nomem_encr == data_new_wave5[row, "nomem_encr"])$DatumE, "%Y-%m-%d")
    }
    
    days <- interval(date_start, date_current) %/% days(1)
    data_new_wave5[row, "month"] <- round(days / 30) + 1
  }
}

# Newly started
data_new_wave5 <- rbind(data_new_wave5, filter(data_wave5, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & !(nomem_encr %in% data_wave4[data_wave4$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

# b <- filter(data_new_wave5, nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)

data_complete <- rbind(data_complete, filter(data_new_wave5, !(nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)))


# === WAVE 6 ===
data_wave6['event'] <- 0
data_wave6['month'] <- 1

data_wave6[data_wave6$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]['event'] <- 1
data_wave6[data_wave6$Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt",]['event'] <- 1

# People that stopped
data_new_wave6 <- filter(data_wave6, Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer" & !(nomem_encr %in% data_wave5[data_wave5$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",]$nomem_encr))

# More people that stopped (but indicated that they never used it)
data_new_wave6 <- rbind(data_new_wave6, filter(data_wave6, Behavior_UTAUT == "Ik heb de CoronaMelder app nooit gebruikt" & (nomem_encr %in% data_wave5[data_wave5$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

# Ongoing users
data_new_wave6 <- rbind(data_new_wave6, filter(data_wave6, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & (nomem_encr %in% data_wave5[data_wave5$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

for (row in 1:nrow(data_new_wave6)) {
  # Like with wave 1, also in later waves it is possible that someone started using and stopped again, even within one wave
  # This checks for that situation, and puts month to 1 if it is the case
  if (is.na(min(data_complete[data_complete$nomem_encr == data_new_wave6[row, "nomem_encr"],]$DatumE))) {
    data_new_wave6[row, "month"] <- 1
  } else {
    
    first_wave <- min(data_complete[data_complete$nomem_encr == data_new_wave6[row, "nomem_encr"],]$wave)
    
    
    # For some reason the date format in waves 5 and 6 are different
    date_current <- as.Date(data_new_wave6[row, "DatumE"], "%Y-%m-%d")
    
    # Now we need to check the date format, because the starting wave could be 1-4 (old format) or 5-6 (new format)
    if(unlist(gregexpr('-', filter(data_complete, wave == first_wave & nomem_encr == data_new_wave6[row, "nomem_encr"])$DatumE))[1] == 3) {
      date_start <- as.Date(filter(data_complete, wave == first_wave & nomem_encr == data_new_wave6[row, "nomem_encr"])$DatumE, "%d-%m-%Y")
      
    } else {
      date_start <- as.Date(filter(data_complete, wave == first_wave & nomem_encr == data_new_wave6[row, "nomem_encr"])$DatumE, "%Y-%m-%d")
    }
    
    days <- interval(date_start, date_current) %/% days(1)
    data_new_wave6[row, "month"] <- round(days / 30) + 1
  }
}

# Newly started
data_new_wave6 <- rbind(data_new_wave6, filter(data_wave6, Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment" & !(nomem_encr %in% data_wave5[data_wave5$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]$nomem_encr)))

#b <- filter(data_new_wave6, nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)

data_complete <- rbind(data_complete, filter(data_new_wave6, !(nomem_encr %in% data_complete[data_complete$event == 1,]$nomem_encr)))

#test <- data_wave6[data_wave6$Behavior_UTAUT == "Ik gebruik de CoronaMelder app op dit moment",]

# Some useful tests for analyses
tmp <- data_complete[, c("nomem_encr", "month", "wave", "event", "DatumE")]
num_respondents <- unique(data_complete$nomem_encr)

num_rightcensored <- data_complete[, c('nomem_encr', 'event')]
num_rightcensored <- num_rightcensored %>% group_by(nomem_encr) %>% filter(event == max(event))
num_rightcensored <- unique(num_rightcensored, by = "nomem_encr")
num_rightcensored <- num_rightcensored[num_rightcensored$event == 0,] # right censored respondents

for (row in 1:nrow(num_rightcensored)) {
  num_rightcensored[row, "last_wave"] <- max(data_complete[data_complete$nomem_encr == num_rightcensored[row, "nomem_encr"]$nomem_encr,]$wave)
}

num_rightcensored_endstudy <- num_rightcensored[num_rightcensored$last_wave != 6,]

  #filter(data_complete, event == 0 & )

# data_wave1_in$stopped_wave = 1
# data_wave2_in$stopped_wave = 2
# data_wave3_in$stopped_wave = 3
# data_wave4_in$stopped_wave = 4
# data_wave5_in$stopped_wave = 5
# data_wave6_in$stopped_wave = 6
# 
# test <- data_wave1_in[data_wave1_in$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",c("nomem_encr", "Awareness", "stopped_wave")]
# 
# test = setDT(test)
# 
# test <- rbind(test, data_wave2_in[data_wave2_in$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",c("nomem_encr", "Awareness", "stopped_wave")])
# 
# test <- rbind(test, data_wave3_in[data_wave3_in$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",c("nomem_encr", "Awareness", "stopped_wave")])
# 
# test <- rbind(test, data_wave4_in[data_wave4_in$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",c("nomem_encr", "Awareness", "stopped_wave")])
# 
# test <- rbind(test, data_wave5_in[data_wave5_in$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",c("nomem_encr", "Awareness", "stopped_wave")])
# 
# test <- rbind(test, data_wave6_in[data_wave6_in$Behavior_UTAUT == "Ik heb de CoronaMelder app in het verleden wel gebruikt maar op dit moment niet meer",c("nomem_encr", "Awareness", "stopped_wave")])
# 
# setkey(test, nomem_encr)
# test <- unique(test, by="nomem_encr")
# 
# test <- na.omit(test)
# 
# n <- test[test$stopped_wave == 6]

 ```
```{=openxml}
<w:p><w:r><w:br w:type="page"/></w:r></w:p>
```
